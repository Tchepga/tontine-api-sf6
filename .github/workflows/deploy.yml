name: Deploy to Hostinger

on:
  push:
    branches:
      - first-step
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "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" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      # - name: Transfer files to Hostinger instance
      #   run: |
      #     scp -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa  -P 65002 -r $PWD u256492878@149.100.151.80:~/public_html/tontine-api

      - name: Connect to Hostinger instance and deploy
        run: |
          ssh -T -i ~/.ssh/id_rsa -p 65002 u256492878@149.100.151.80 << EOF

            # access to the directory of the project
            cd ~/public_html/tontine-api

            # delete cache directory
            rm -rf var

            # pull changes
            git checkout  first-step
            git reset --hard origin/first-step

            # use the current composer.phar (should setup composer each time)
            cp ~/public_html/composer.phar ~/public_html/tontine-api

            # Stop the currently running Symfony process (if any)
            #if [ -f ./var/run/symfony.pid ]; then
            #    kill \$(cat ./var/run/symfony.pid)
            #    rm ./var/run/symfony.pid
            #fi

            # Install dependencies
            php composer.phar install
            # composer install --no-dev --optimize-autoloader

            # start docker postgresql daemon and migrate the database changes
            bin/console doctrine:migrations:migrate

            # Clear cache
            php bin/console cache:clear  --no-warmup
            php bin/console cache:warmup

            exit
          EOF
